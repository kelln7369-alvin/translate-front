<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å³æ™‚èªéŸ³ AI ç¿»è­¯ï¼ˆæ®µè½æ¨¡å¼ / Flask å¾Œç«¯ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body { height:100% } .card{border:1px solid #e5e7eb} .scroll-area{scroll-behavior:smooth}
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-sky-50 via-white to-indigo-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-4 md:p-6 space-y-4">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-semibold">ğŸ§ å³æ™‚èªéŸ³ AI ç¿»è­¯ â€“ æ®µè½æ¨¡å¼</h1>
      <span class="text-xs text-slate-500">Flask å¾Œç«¯ç‰ˆ</span>
    </header>

    <!-- è¨­å®šåˆ— -->
    <section class="grid gap-3 md:grid-cols-2">
      <div class="rounded-2xl p-4 shadow bg-white grid gap-3">
        <div class="grid grid-cols-3 gap-2">
          <div>
            <label class="block text-sm font-medium mb-1">ASR èªè¨€</label>
            <select id="inputLang" class="w-full rounded-xl border p-2">
              <option value="">è‡ªå‹•/é è¨­</option>
              <option value="cmn-Hant-TW" selected>ä¸­æ–‡ï¼ˆç¹é«”ï¼‰</option>
              <option value="en-US">English (US)</option>
              <option value="ja-JP">æ—¥æœ¬èª</option>
              <option value="ko-KR">í•œêµ­ì–´</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ç¿»è­¯ç›®æ¨™èªè¨€</label>
            <select id="targetLang" class="w-full rounded-xl border p-2">
              <option value="zh-TW">ä¸­æ–‡ï¼ˆç¹é«”ï¼‰</option>
              <option value="en" selected>English</option>
              <option value="ja">æ—¥æœ¬èª</option>
              <option value="ko">í•œêµ­ì–´</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">æ¨¡å‹</label>
            <select id="modelId" class="w-full rounded-xl border p-2">
              <option value="gpt-4o-mini">gpt-4o-miniï¼ˆæ¨è–¦ï¼‰</option>
              <option value="o4-mini">o4-mini</option>
              <option value="gpt-4o">gpt-4o</option>
            </select>
          </div>
        </div>

        <!-- æ–°å¢ï¼šå››å€‹å¿«æ·åˆ‡æ›æŒ‰éˆ•ï¼ˆä¸­â†’è‹±ã€è‹±â†’ä¸­ã€ä¸­â†’æ—¥ã€æ—¥â†’ä¸­ï¼‰ -->
        <div class="flex flex-wrap items-center gap-2">
          <button id="presetZhEn" class="rounded-xl bg-slate-100 px-3 py-1.5 text-sm font-medium">ä¸­â†’è‹±</button>
          <button id="presetEnZh" class="rounded-xl bg-slate-100 px-3 py-1.5 text-sm font-medium">è‹±â†’ä¸­</button>
          <button id="presetZhJa" class="rounded-xl bg-slate-100 px-3 py-1.5 text-sm font-medium">ä¸­â†’æ—¥</button>
          <button id="presetJaZh" class="rounded-xl bg-slate-100 px-3 py-1.5 text-sm font-medium">æ—¥â†’ä¸­</button>
        </div>

        <div class="flex items-center gap-2">
          <button id="startBtn" class="flex-1 rounded-xl bg-indigo-600 text-white py-2 font-medium hover:bg-indigo-700">é–‹å§‹æ”¶éŸ³</button>
          <button id="stopBtn"  class="rounded-xl bg-slate-200 py-2 px-3 font-medium" disabled>åœæ­¢</button>
          <button id="saveBtn"  class="rounded-xl bg-emerald-600 text-white py-2 px-3 font-medium" disabled>ä¿å­˜æœ¬æ®µ âŒ˜/Ctrl+Enter</button>
          <button id="clearBtn" class="rounded-xl bg-slate-100 py-2 px-3 font-medium">æ¸…ç©ºè‰ç¨¿</button>
        </div>
        <p id="status" class="text-xs text-slate-500">ç‹€æ…‹ï¼šå¾…æ©Ÿ</p>
      </div>
    </section>

    <!-- é›™æ¬„ï¼šé€å­—ç¨¿ / åŒæ­¥ç¿»è­¯ -->
    <section class="grid md:grid-cols-2 gap-3">
      <div class="rounded-3xl shadow bg-white p-4 space-y-2">
        <div class="text-sm text-slate-500">é€å­—ç¨¿ï¼ˆå¯ç·¨è¼¯ï¼‰</div>
        <textarea id="srcBox" rows="10" class="w-full resize-y outline-none p-3 rounded-xl border"></textarea>
      </div>
      <div class="rounded-3xl shadow bg-white p-4 space-y-2">
        <div class="text-sm text-slate-500">åŒæ­¥ç¿»è­¯</div>
        <textarea id="tgtBox" rows="10" class="w-full resize-y outline-none p-3 rounded-xl border bg-slate-50" readonly></textarea>
      </div>
    </section>

    <!-- ç´€éŒ„ -->
    <section>
      <div class="rounded-3xl shadow bg-white">
        <div class="px-6 py-3 border-b text-sm text-slate-500">å°è©±ç´€éŒ„</div>
        <div id="log" class="scroll-area max-h-[48vh] overflow-auto p-6 space-y-4"></div>
      </div>
    </section>
  </div>

 <script>
  // è‹¥éƒ¨ç½²åœ¨ GitHub Pagesï¼Œè«‹æŠŠ <YOUR-RENDER-SERVICE> æ”¹æˆä½ åœ¨ Render çš„æœå‹™åç¨±ã€‚

  // ===== DOM =====
  const inputLangEl = document.getElementById('inputLang');
  const targetEl = document.getElementById('targetLang');
  const modelEl  = document.getElementById('modelId');
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const saveBtn  = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearBtn');
  const statusEl = document.getElementById('status');
  const srcBox   = document.getElementById('srcBox');
  const tgtBox   = document.getElementById('tgtBox');
  const logEl    = document.getElementById('log');

  // æ–°å¢ï¼šå¿«æ·æŒ‰éˆ•å…ƒç´ 
  const btnZhEn = document.getElementById('presetZhEn');
  const btnEnZh = document.getElementById('presetEnZh');
  const btnZhJa = document.getElementById('presetZhJa');
  const btnJaZh = document.getElementById('presetJaZh');

  // å¾Œç«¯ä½å€ï¼ˆè‹¥ä½ æ”¹äº†å¾Œç«¯åŸ ï¼Œé€™è£¡ä¹Ÿè¦ä¸€èµ·æ”¹ï¼‰
  const BACKEND = (location.hostname.endsWith("github.io") || location.protocol === "file:")
  ? "https://<YOUR-RENDER-SERVICE>.onrender.com"
  : `${location.protocol}//${location.hostname}:5501`;

  // ===== å°å·¥å…· =====
  let recognizing = false, recognition = null, lastTranslated = "";
  const debounce = (fn, delay=700)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); } }
  const escapeHtml = s => (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
  function setStatus(msg){ statusEl.textContent = "ç‹€æ…‹ï¼š" + msg; }
  function addLogItem(src, tgt){
    const card = document.createElement('div');
    card.className = "card rounded-2xl p-4";
    card.innerHTML = `
      <div class="text-xs text-slate-500 mb-2">åŸæ–‡</div>
      <div class="whitespace-pre-wrap mb-3">${escapeHtml(src)}</div>
      <div class="text-xs text-slate-500 mb-2">ç¿»è­¯</div>
      <div class="whitespace-pre-wrap font-medium">${escapeHtml(tgt)}</div>`;
    logEl.appendChild(card); logEl.scrollTop = logEl.scrollHeight;
  }

  // ===== å¾Œç«¯ç¿»è­¯ =====
  async function translate(text){
    const r = await fetch(`${BACKEND}/translate`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text, target: targetEl.value, model: modelEl.value })
    });
    if(!r.ok){
      const t = await r.text().catch(()=>r.statusText);
      throw new Error(`å¾Œç«¯ ${r.status}: ${t}`);
    }
    const obj = await r.json();
    return obj.translation || "";
  }

  const debouncedTranslate = debounce(async ()=>{
    const text = srcBox.value.trim();
    if(!text){ tgtBox.value = ""; return; }
    if(text === lastTranslated) return;
    lastTranslated = text;
    try{
      setStatus("ç¿»è­¯ä¸­â€¦");
      tgtBox.value = await translate(text);
      setStatus("å°±ç·’");
    }catch(e){
      tgtBox.value = `ã€ç¿»è­¯å¤±æ•—ã€‘${e.message}`;
      setStatus("ç¿»è­¯å¤±æ•—");
    }
  }, 700);

  srcBox.addEventListener('input', debouncedTranslate);

  // ===== éŸ³è¨Šæ¬Šé™ï¼æ”¯æ´åµæ¸¬ =====
  function isSecureContextOk(){
    // getUserMedia åªèƒ½åœ¨ HTTPS æˆ– localhost ä½¿ç”¨
    const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
    return (location.protocol === "https:" || isLocalhost);
  }

  function isMediaSupported(){
    return !!(navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === "function");
  }

  async function checkMicrophonePermission(){
    try{
      if (!navigator.permissions?.query) return "unknown";
      const p = await navigator.permissions.query({ name: "microphone" });
      return p.state; // 'granted' | 'denied' | 'prompt'
    }catch{ return "unknown"; }
  }

  async function requestMic(){
    // 1) å®‰å…¨æƒ…å¢ƒæª¢æŸ¥ï¼ˆHTTPS / localhostï¼‰
    if (!isSecureContextOk()){
      throw new Error("æ­¤é é¢ä¸æ˜¯ HTTPSï¼ˆæˆ– localhostï¼‰ã€‚ç€è¦½å™¨ç‚ºäº†å®‰å…¨ä¸å…è¨±é–‹éº¥ã€‚è«‹æ”¹ç”¨ https:// ç¶²å€é–‹å•Ÿï¼Œæˆ–åœ¨ Synology å•Ÿç”¨æ†‘è­‰/åå‘ä»£ç†ã€‚");
    }

    // 2) API æ”¯æ´æª¢æŸ¥
    if (!isMediaSupported()){
      throw new Error("ç€è¦½å™¨ä¸æ”¯æ´ getUserMediaã€‚è«‹æ”¹ç”¨æ¡Œæ©Ÿç‰ˆ Chrome/Edge/Firefox æœ€æ–°ç‰ˆï¼Œæˆ–æ›´æ–°ç€è¦½å™¨ã€‚");
    }

    // 3) æ¬Šé™ç‹€æ…‹æç¤º
    const state = await checkMicrophonePermission();
    if (state === "denied"){
      throw new Error("éº¥å…‹é¢¨æ¬Šé™è¢«å°é–ã€‚è«‹é»ç¶²å€åˆ—å·¦é‚Šçš„é–é ­ â†’ å…è¨±ã€éº¥å…‹é¢¨ã€ï¼Œç„¶å¾Œé‡æ–°æ•´ç†é é¢ã€‚");
    }

    // 4) çœŸæ­£è¦æ¬Šé™
    try{
      window.currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }catch(err){
      const map = {
        NotAllowedError: "ä½ æ‹’çµ•äº†éº¥å…‹é¢¨æ¬Šé™ã€‚è«‹å…è¨±å¾Œå†è©¦ä¸€æ¬¡ã€‚",
        NotFoundError: "æ‰¾ä¸åˆ°å¯ç”¨çš„éº¥å…‹é¢¨è£ç½®ã€‚",
        NotReadableError: "éº¥å…‹é¢¨è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½”ç”¨ï¼Œæˆ–ç³»çµ±é˜»æ“‹å­˜å–ã€‚",
        OverconstrainedError: "è¦æ±‚çš„éŸ³è¨Šæ¢ä»¶ä¸è¢«æ”¯æ´ã€‚",
        SecurityError: "å®‰å…¨æ€§é™åˆ¶é˜»æ“‹å­˜å–ï¼ˆè«‹æ”¹ç”¨ HTTPSï¼‰ã€‚"
      };
      const msg = map[err?.name] || (err?.message || "ç„¡æ³•é–‹å•Ÿéº¥å…‹é¢¨");
      throw new Error(msg);
    }
  }

  // ===== Web Speech ASR =====
  function ensureASRSupported(){
    const ok = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
    if(!ok) throw new Error("æ­¤ç€è¦½å™¨æœªæ”¯æ´ Web Speech APIï¼ˆå»ºè­°æ¡Œæ©Ÿç‰ˆ Chromeï¼‰ã€‚");
  }

  function startASR(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    const lang = inputLangEl.value.trim();
    if (lang) recognition.lang = lang;
    recognition.continuous = true;
    recognition.interimResults = true;

    let finalBuf = "";
    recognition.onresult = (evt)=>{
      if(!recognizing) return;
      let interim="";
      for(let i=evt.resultIndex;i<evt.results.length;i++){
        const r=evt.results[i];
        if(r.isFinal) finalBuf += r[0].transcript + " ";
        else interim += r[0].transcript;
      }
      const live = (finalBuf + (interim ? " " + interim : "")).trim();
      srcBox.value = live; debouncedTranslate();
    };
    recognition.onerror = (e)=>{
      const human = {
        'no-speech':'æ²’æœ‰æ”¶åˆ°èªéŸ³',
        'audio-capture':'æ‰¾ä¸åˆ°éº¥å…‹é¢¨',
        'not-allowed':'éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’'
      }[e.error] || e.error || 'æœªçŸ¥';
      setStatus("è¾¨è­˜éŒ¯èª¤ - " + human);
    };
    recognition.onend = ()=>{ if(recognizing) recognition.start(); };
    recognition.start(); recognizing = true;
  }

  function stopAll(){
    recognizing=false;
    if(recognition){ try{ recognition.onend=null; recognition.stop(); }catch(e){} recognition=null; }
  }

  // ===== äº‹ä»¶ç¶å®š =====
  startBtn.addEventListener('click', async ()=>{
    try{
      ensureASRSupported();
      setStatus("æª¢æŸ¥éº¥å…‹é¢¨æ¬Šé™â€¦");
      await requestMic();

      startBtn.disabled=true; stopBtn.disabled=false; saveBtn.disabled=false;
      setStatus("å·²å•Ÿå‹•éº¥å…‹é¢¨ï¼Œè½å¯«ä¸­â€¦");
      startASR();
    }catch(e){
      setStatus(e.message);
      startBtn.disabled=false; stopBtn.disabled=true; saveBtn.disabled=true;
    }
  });

  stopBtn.addEventListener('click', ()=>{
    stopAll(); startBtn.disabled=false; stopBtn.disabled=true;
    // é—œé–‰éº¥å…‹é¢¨éŸ³è¨Šä¸²æµ
    if (window.currentStream) {
      window.currentStream.getTracks().forEach(track => track.stop());
      window.currentStream = null;
    }
    setStatus("å·²åœæ­¢è½å¯«");
  });

  clearBtn.addEventListener('click', ()=>{
    srcBox.value=""; tgtBox.value=""; lastTranslated="";
    setStatus("è‰ç¨¿å·²æ¸…ç©º");
  });

  function saveCurrent(){
    const s=srcBox.value.trim(), t=tgtBox.value.trim();
    if(!s && !t) return;
    addLogItem(s,t);
    srcBox.value=""; tgtBox.value=""; lastTranslated="";
    setStatus("å·²ä¿å­˜ä¸€æ®µï¼Œé–‹å§‹ä¸‹ä¸€æ®µâ€¦");
  }
  saveBtn.addEventListener('click', saveCurrent);
  document.addEventListener('keydown',(e)=>{ if((e.metaKey||e.ctrlKey)&&e.key==="Enter"){ e.preventDefault(); saveCurrent(); } });

  // æ–°å¢ï¼šå››å€‹é è¨­èªå‘åˆ‡æ›
  function applyPreset(asrLang, targetLang){
    inputLangEl.value = asrLang;
    targetEl.value = targetLang;
    setStatus("å·²å¥—ç”¨é è¨­ï¼š" + (asrLang || "è‡ªå‹•") + " â†’ " + targetLang);
  }
  btnZhEn.addEventListener('click', ()=>applyPreset('cmn-Hant-TW','en'));
  btnEnZh.addEventListener('click', ()=>applyPreset('en-US','zh-TW'));
  btnZhJa.addEventListener('click', ()=>applyPreset('cmn-Hant-TW','ja'));
  btnJaZh.addEventListener('click', ()=>applyPreset('ja-JP','zh-TW'));

  // å•Ÿå‹•æ™‚æª¢æŸ¥ HTTPS èˆ‡å¾Œç«¯å¯ç”¨æ€§
  (async () => {
    if (!isSecureContextOk()){
      setStatus("åµæ¸¬åˆ°é HTTPSï¼ˆæˆ–é localhostï¼‰ã€‚ç‚ºäº†èƒ½é–‹å•Ÿéº¥å…‹é¢¨ï¼Œè«‹ç”¨ https:// çš„ç¶²å€å­˜å–æ­¤é é¢ã€‚");
    } else {
      setStatus("å°±ç·’ï¼ˆå·²é€£ä¸Šå¾Œç«¯å‰å†è©¦éº¥å…‹é¢¨ï¼‰");
    }
    try {
      const r = await fetch(`${BACKEND}/translate`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text:"ping", target:"en", model:"gpt-4o-mini" })
      });
      if(!r.ok) throw new Error();
    } catch {
      setStatus("æé†’ï¼šå‰ç«¯å·²è¼‰å…¥ï¼Œä½†å¾Œç«¯ä¹Ÿéœ€è¦å•Ÿå‹•ä¸¦é–‹æ”¾ 5501 æ‰èƒ½ç¿»è­¯ã€‚");
    }
  })();
</script>

</body>
</html>
